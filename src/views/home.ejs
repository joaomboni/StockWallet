<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>StockWallet</title>
    <link rel="stylesheet" href="../public/styles/style.css">
</head>
<body>

<header>
    <div class="logo">
        <h1><span>STOCK</span>WALLET</h1>
        <p>INVISTA CONSCIENTE</p>
    </div>

    <div class="search-box">
        <form id="formBusca">
            <input id="symbolInput" type="text" placeholder="Procurar por a√ß√£o/empresa">
            <button type="submit">EXIBIR</button>
        </form>
    </div>
</header>

<nav>
    <a class="active" href="#">P√ÅGINA INICIAL</a>
    <a href="#">SEED</a>
<!--    <div class="dropdown">-->
<!--        <button class="dropbtn">MAIS OP√á√ïES ‚ñº</button>-->
<!--        <div class="dropdown-content">-->
<!--            <a href="#">Indicadores</a>-->
<!--            <a href="#">Setores</a>-->
<!--            <a href="#">Compara√ß√µes</a>-->
<!--        </div>-->
<!--    </div>-->
<!--    <a href="#">ENTRE EM CONTATO</a>-->
<!--    <a href="#">FUNDAMENTUS MOBILE</a>-->
</nav>

<section class="intro">
    <p>
        Bem-vindo ao StockWallet ‚Äî sua plataforma para decis√µes de investimento mais inteligentes.
    </p>

    <!--<img src="../public/image/dollar.png" alt="Dinheiro">-->
</section>

<!-- Tabela com dados fundamentalistas-->
<section id="tabelaResultados"></section>

<!-- Plotar Grafico -->

<section id="graficoContainer" class="hidden grafico-box"></section>

<section class="cards-grid" id="cardsContainer">
    <!-- Cards ser√£o gerados por JS -->
</section>

<!-- POPUP PARA INSERIR SYMBOL -->
<div id="popup" class="popup hidden">
    <div class="popup-content">
        <h3>Adicionar A√ß√£o</h3>
        <input id="popupSymbol" type="text" placeholder="Ex: BBAS3.SA">
        <button id="popupAdd">Adicionar</button>
        <button id="popupCancel">Cancelar</button>
    </div>
</div>

<section class="features">
    <h2>Funcionalidades</h2>

    <ul>
        <li>üìä Calculo de Pre√ßo Justo de A√ß√µes no Mundo.</li>
        <!--<li>üîç Pesquisa avan√ßada com filtros por PL, PVP, PSR, Dividend Yield, etc.</li>
        <li>üè≠ Compara√ß√£o de empresas por setores e subsetores.</li>
        <li>üìà Visualiza√ß√£o gr√°fica dos indicadores.</li>
        <li>üì• Download dos dados em Excel.</li>-->
    </ul>
</section>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial/dist/chartjs-chart-financial.min.js"></script>
<script>


    function desenharSkeletons(qtd = 6) {
        const container = document.getElementById('cardsContainer');
        container.innerHTML = '';
        for (let i = 0; i < qtd; i++) {
            const sk = document.createElement('div');
            sk.className = 'card-skeleton';
            container.appendChild(sk);
        }
    }

    document.getElementById("formBusca").addEventListener("submit", async (e) => {
        e.preventDefault();  // impede reload

        const symbol = document.getElementById("symbolInput").value.trim();
        if (!symbol) return alert("Digite um ticker, ex: BBAS3.SA");

        carregatabela(symbol);
        carregarGrafico(symbol);
    });

    async function carregarGrafico(symbol) {
        const container = document.getElementById("graficoContainer");
        container.classList.add("hidden");
        container.innerHTML = "";

        const canvas = document.createElement("canvas");
        canvas.id = "graficoCanvas";
        canvas.width = 600;
        canvas.height = 350;
        container.appendChild(canvas);

        const resp = await fetch(`/api/getCharts`,{
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ symbol })
        });
        if (!resp.ok) {
            container.innerHTML = "<p style='color:red'>Erro ao carregar gr√°fico.</p>";
            return;
        }

        const { candles, closes, ema200, ema50 } = await resp.json();
        const labels = candles.map(c => c.date.split("T")[0]); // YYYY-MM-DD
        const closePrices = closes;
        const emaG200 = ema200;
        const emaG50 = ema50;


        if (window.myChart) window.myChart.destroy();

        const ctx = document.getElementById("graficoCanvas").getContext("2d");

        window.myChart = new Chart(ctx, {
            type: "line",
            data: {
                labels,
                datasets: [
                    {
                        label: "Pre√ßo",
                        data: closePrices,
                        borderWidth: 2,
                        pointRadius: 0,
                    },
                    {
                        label: "EMA200",
                        data: emaG200,
                        borderWidth: 2,
                        pointRadius: 0,
                    },
                    {
                        label: "EMA50",
                        data: emaG50,
                        borderWidth: 1,
                        pointRadius: 0,
                    }
                ]
            },
            options: {
                responsive: false,
                scales: {
                    x: { display: true },
                    y: { display: true },
                }
            }
        });

        document.getElementById("graficoContainer").classList.remove("hidden");

    }


    async function carregatabela(symbol) {

        const container = document.getElementById("tabelaResultados");
        container.innerHTML = "<p>Carregando dados...</p>";

        if(symbol === "BTC" || symbol === "btc"){
            container.innerHTML = "<p style='color:red'>Bitcon n√£o gera tabela de dados fundamentalista.</p>"
            return;
        }

        try {
            const resp = await fetch(`/api/fundamentals`,{
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ symbol })
            });

            if (!resp.ok) throw new Error("Falha para obter dados");

            const fundamentals = await resp.json();

            container.innerHTML = gerarTabela(fundamentals);



        } catch (error) {
            console.error(error);
            container.innerHTML = "<p style='color:red'>Erro ao carregar dados.</p>";
        }
    }

    function gerarTabela(data) {
        const table = data.fundamentals ?? {};

        const indicadores = [
            ["S√≠mbolo", data.symbol],
            ["Pre√ßo Atual", table.cotacao],
            ["Pre√ßo Justo", data.precoJusto],
            ["Tipo", table.tipo],
            ["Empresa", table.empresa],
            ["Setor", table.setor],
            ["Valor de Mercado", table.valorMercado],
            ["P/L", table.pl],
            ["P/VP", table.pvp],
            ["PSR", table.psr],
            ["LPA", table.lpa],
            ["VPA", table.vpa],
            ["ROE", table.roe],
            ["EV/EBITDA", table.evEbitda],
            ["Dividend Yield", table.dividendYield
                ? (table.dividendYield * 100).toFixed(2) + "%"
                : "-"
            ],
            ["EV/EBIT", table.evEbit],
            ["ROIC", table.roic],
            ["Liquidez Corrente", table.liquidezCorrente],
            ["Div Br/Patrim.", table.divBrPatrim]
        ];

        const numColunas = 2; // Total de colunas
        const porColuna = Math.ceil(indicadores.length / numColunas);

        let html = `<div class="fund-grid">`;

        for (let i = 0; i < numColunas; i++) {
            html += `<table class="fund-table">`;


            indicadores.slice(i * porColuna, (i + 1) * porColuna).forEach(([label, valor]) => {
                html += `
                <tr>
                    <th>${label}</th>
                    <td>${valor ?? "-"}</td>
                </tr>
            `;
            });

            html += `</table>`;
        }

        html += `</div>`;
        return html;
    }

    async function carregarCards() {
        const container = document.getElementById("cardsContainer");
        container.innerHTML = "";

        let lista = [];
        try {
            const resp = await fetch("/api/list-preco-justo");
            if (!resp.ok) throw new Error("Falha ao listar cards");
            lista = await resp.json();
        } catch (e) {
            console.error(e);
        }

        // Renderiza cards existentes
        lista.forEach(item => criarCard(item));

        // Completa at√© 6 slots com bot√£o de +
        const faltam = Math.max(0, 12 - lista.length);
        for (let i = 0; i < faltam; i++) {
            criarCardPlus();
        }
    }

    function criarCard(item) {
        const fundamentals = item.fundamentos ?? {};
        const card = document.createElement("div");
        card.classList.add("card-mini");

        card.innerHTML = `
        <button class="delete-btn" data-id="${item._id}">üóëÔ∏è</button>

        <h3>${item.symbol}</h3>
        <p><strong>Pre√ßo Atual:</strong> R$ ${fundamentals.price ?? "-"}</p>
        <p><strong>Pre√ßo Justo:</strong> R$ ${item.precoJusto ?? "-"}</p>
        <p><strong>LPA:</strong> ${fundamentals.lpa ?? "-"}</p>
        <p><strong>VPA:</strong> ${fundamentals.vpa ?? "-"}</p>
        <p><strong>P/L:</strong> ${fundamentals.pl ?? "-"}</p>
        <p><strong>P/VP:</strong> ${fundamentals.pvp ?? "-"}</p>
        <p><strong>DY:</strong> ${
            fundamentals.dividendYield
                ? (fundamentals.dividendYield * 100).toFixed(2) + "%"
                : "-"
        }</p>
    `;

        document.getElementById("cardsContainer").appendChild(card);

        // Listener do bot√£o deletar
        card.querySelector(".delete-btn").addEventListener("click", async () => {
            if (!confirm(`Remover ${item.symbol}?`)) return;

            try {
                const resp = await fetch(`/api/delete-preco-justo/${item.symbol}`, {
                    method: "DELETE",
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbol: item.symbol })
                });

                if (resp.ok) {
                    carregarCards();
                } else {
                    alert("Erro ao deletar registro.");
                }
            } catch (err) {
                alert("Falha ao conectar com servidor.");
            }
        });
    }

    function criarCardPlus() {
        const plus = document.createElement("div");
        plus.classList.add("card-plus");
        plus.textContent = "+";
        plus.addEventListener("click", () => {
            document.getElementById("popup").classList.remove("hidden");
            document.getElementById("popupSymbol").focus();
        });
        document.getElementById("cardsContainer").appendChild(plus);
    }

    // ------ POPUP ------
    document.getElementById("popupCancel").addEventListener("click", () => {
        document.getElementById("popup").classList.add("hidden");
        document.getElementById("popupSymbol").value = "";
    });

    document.getElementById("popupAdd").addEventListener("click", async () => {
        const input = document.getElementById("popupSymbol");
        const symbol = input.value.trim();
        if (!symbol) return;

        try {
            const resp = await fetch("/api/create-preco-justo", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ symbol })
            });

            const data = await resp.json();
            if (!resp.ok) {
                alert(data.error || "Falha ao criar registro");
            }
        } catch (e) {
            console.error(e);
            alert("Erro ao criar registro");
        }

        document.getElementById("popup").classList.add("hidden");
        input.value = "";

        // Recarrega a grade
        await carregarCards();
    });

    // Carregar ao iniciar
    carregarCards();

    // Polling a cada 5 minutos (ajuste conforme necess√°rio)
    const FIVE_MIN = 5 * 60 * 1000;
    let pollingTimer = null;
    let carregando = false; // evita sobreposi√ß√£o

    async function tick() {
        if (carregando) return;
        carregando = true;
        try { await carregarCards(); } finally { carregando = false; }
    }

    pollingTimer = setInterval(tick, FIVE_MIN);

    // Atualiza imediatamente quando a aba volta a ficar vis√≠vel
    document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible') tick();
    });

</script>


</body>
</html>
