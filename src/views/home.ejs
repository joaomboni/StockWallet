<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>StockWallet</title>
    <link rel="stylesheet" href="../public/styles/style.css">
</head>
<body>

<header>
    <div class="logo">
        <h1><span>STOCK</span>WALLET</h1>
        <p>INVISTA CONSCIENTE</p>
    </div>

    <div class="search-box">
        <form id="formBusca">
            <input id="symbolInput" type="text" placeholder="Procurar por a√ß√£o/empresa">
            <button type="submit">EXIBIR</button>
        </form>
    </div>
</header>

<nav>
    <a class="active" href="#">P√ÅGINA INICIAL</a>
    <a href="#">INVESTIMENTO CONSCIENTE</a>
    <div class="dropdown">
        <button class="dropbtn">MAIS OP√á√ïES ‚ñº</button>
        <div class="dropdown-content">
            <a href="#">Indicadores</a>
            <a href="#">Setores</a>
            <a href="#">Compara√ß√µes</a>
        </div>
    </div>
    <a href="#">ENTRE EM CONTATO</a>
    <a href="#">FUNDAMENTUS MOBILE</a>
</nav>

<section class="intro">
    <p>
        Fundamentus √© um sistema on-line que disponibiliza informa√ß√µes financeiras e
        fundamentalistas das empresas com a√ß√µes listadas na Bovespa. Possu√≠mos um
        completo banco de dados apresentado de forma acess√≠vel para auxiliar
        o investidor a encontrar as melhores op√ß√µes de investimento.
    </p>

    <img src="https://www.luiztools.com.br/wp-content/uploads/2018/08/dinheiro.jpg" alt="Dinheiro">
</section>

<section class="cards-grid" id="cardsContainer">
    <!-- Cards ser√£o gerados por JS -->
</section>

<!-- POPUP PARA INSERIR SYMBOL -->
<div id="popup" class="popup hidden">
    <div class="popup-content">
        <h3>Adicionar A√ß√£o</h3>
        <input id="popupSymbol" type="text" placeholder="Ex: BBAS3.SA">
        <button id="popupAdd">Adicionar</button>
        <button id="popupCancel">Cancelar</button>
    </div>
</div>

<section class="features">
    <h2>Funcionalidades</h2>

    <ul>
        <li>üìä Calculo de Pre√ßo Justo de A√ß√µes no Mundo.</li>
        <!--<li>üîç Pesquisa avan√ßada com filtros por PL, PVP, PSR, Dividend Yield, etc.</li>
        <li>üè≠ Compara√ß√£o de empresas por setores e subsetores.</li>
        <li>üìà Visualiza√ß√£o gr√°fica dos indicadores.</li>
        <li>üì• Download dos dados em Excel.</li>-->
    </ul>
</section>

<script>
    async function carregarCards() {
        const container = document.getElementById("cardsContainer");
        container.innerHTML = "";

        let lista = [];
        try {
            const resp = await fetch("/api/create-preco-justo");
            if (!resp.ok) throw new Error("Falha ao listar cards");
            lista = await resp.json();
        } catch (e) {
            console.error(e);
        }

        // Renderiza cards existentes
        lista.forEach(item => criarCard(item));

        // Completa at√© 6 slots com bot√£o de +
        const faltam = Math.max(0, 6 - lista.length);
        for (let i = 0; i < faltam; i++) {
            criarCardPlus();
        }
    }

    function criarCard(item) {
        const fundamentals = item.fundamentos ?? {};
        const card = document.createElement("div");
        card.classList.add("card-mini");
        card.innerHTML = `
      <h3>${item.symbol}</h3>
      <p><strong>Pre√ßo Atual:</strong> R$ ${fundamentals.price ?? "-"}</p>
      <p><strong>Pre√ßo Justo:</strong> R$ ${item.precoJusto ?? "-"}</p>
      <p><strong>LPA:</strong> ${fundamentals.lpa ?? "-"}</p>
      <p><strong>VPA:</strong> ${fundamentals.vpa ?? "-"}</p>
      <p><strong>P/L:</strong> ${fundamentals.pl ?? "-"}</p>
      <p><strong>P/VP:</strong> ${fundamentals.pvp ?? "-"}</p>
      <p><strong>DY:</strong> ${
            fundamentals.dividendYield
                ? (fundamentals.dividendYield * 100).toFixed(2) + "%"
                : "-"
        }</p>
    `;
        document.getElementById("cardsContainer").appendChild(card);
    }

    function criarCardPlus() {
        const plus = document.createElement("div");
        plus.classList.add("card-plus");
        plus.textContent = "+";
        plus.addEventListener("click", () => {
            document.getElementById("popup").classList.remove("hidden");
            document.getElementById("popupSymbol").focus();
        });
        document.getElementById("cardsContainer").appendChild(plus);
    }

    // ------ POPUP ------
    document.getElementById("popupCancel").addEventListener("click", () => {
        document.getElementById("popup").classList.add("hidden");
        document.getElementById("popupSymbol").value = "";
    });

    document.getElementById("popupAdd").addEventListener("click", async () => {
        const input = document.getElementById("popupSymbol");
        const symbol = input.value.trim();
        if (!symbol) return;

        try {
            const resp = await fetch("/api/create-preco-justo", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ symbol })
            });

            const data = await resp.json();
            if (!resp.ok) {
                alert(data.error || "Falha ao criar registro");
            }
        } catch (e) {
            console.error(e);
            alert("Erro ao criar registro");
        }

        document.getElementById("popup").classList.add("hidden");
        input.value = "";

        // Recarrega a grade
        await carregarCards();
    });

    // Carregar ao iniciar
    carregarCards();
</script>


</body>
</html>
